<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>タイピングゲーム</title>
<style>
  /* Basic layout and lane styles */
  body {
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }
  #game {
    position: relative;
    width: 90vw;
    max-width: 400px;
    height: 500px;
    border: 1px solid #333;
    overflow: hidden;
    display: flex;
  }
  .lane {
    flex: 1;
    border-left: 1px solid #999;
    border-right: 1px solid #999;
    position: relative;
  }
  .note {
    position: absolute;
    width: 100%;
    height: 20px;
    background: #3498db;
    top: -20px;
  }
  /* line player must hit notes on */
  #hit-line {
    position: absolute;
    bottom: 60px;
    left: 0;
    width: 100%;
    height: 2px;
    background: red;
  }
  #combo {
    margin-left: 20px;
    font-size: 1.5em;
  }
  .effect {
    position: absolute;
    bottom: 60px;
    width: 100%;
    height: 20px;
    background: rgba(255,255,0,0.5);
    animation: flash 0.3s ease-out;
  }
  @keyframes flash {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  /* result modal overlay */
  #result {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
  }
  /* modal inner box */
  #result-content {
    background: #fff;
    padding: 20px;
    text-align: center;
    min-width: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #retry-toggle {
    margin-top: 10px;
  }
  #retry {
    margin: 10px auto 0;
    padding: 5px 10px;
  }
</style>
</head>
<body>
<div id="game">
  <div class="lane" id="lane0"></div>
  <div class="lane" id="lane1"></div>
  <div class="lane" id="lane2"></div>
  <div class="lane" id="lane3"></div>
  <div id="hit-line"></div>
</div>
<div id="combo">Combo: 0</div>
<div id="result">
  <div id="result-content">
    <div id="result-text"></div>
    <div id="records"></div>
    <label id="retry-toggle"><input type="checkbox"> Retry 有効</label>
    <button id="retry" disabled>再挑戦</button>
  </div>
</div>
<script>
// Lane elements corresponding to keys D/F/J/K
const lanes = [
  document.getElementById('lane0'),
  document.getElementById('lane1'),
  document.getElementById('lane2'),
  document.getElementById('lane3')
];
// Active notes on screen
let notes = [];
// Current combo count
let combo = 0;
// Interval IDs for spawning and moving notes
let gameInterval;
let moveInterval;
// Whether the game is running
let running = false;
// UI elements
const comboEl = document.getElementById('combo');
const result = document.getElementById('result');
const resultText = document.getElementById('result-text');
const recordsEl = document.getElementById('records');
const retryBtn = document.getElementById('retry');
const retryToggle = document.querySelector('#retry-toggle input');

// Start a new round
function startGame() {
  notes = [];
  combo = 0;
  comboEl.textContent = 'Combo: 0';
  lanes.forEach(l => l.innerHTML = '');
  running = true;
  result.style.display = 'none';
  retryBtn.disabled = true;
  retryToggle.checked = false;
  gameInterval = setInterval(spawnNote, 800);
  moveInterval = setInterval(moveNotes, 20);
}

// Finish the game and show results
function endGame() {
  running = false;
  clearInterval(gameInterval);
  clearInterval(moveInterval);
  updateRecords(combo);
  showResult();
}

// Create a note in a random lane
function spawnNote() {
  const laneIndex = Math.floor(Math.random()*4);
  const note = document.createElement('div');
  note.className = 'note';
  note.dataset.lane = laneIndex;
  note.style.top = '-20px';
  lanes[laneIndex].appendChild(note);
  notes.push(note);
}

// Move notes downward each frame
function moveNotes() {
  notes.forEach((note, idx) => {
    const top = parseInt(note.style.top) + 4;
    note.style.top = top + 'px';
    if (top > 500) {
      endGame();
    }
  });
  notes = notes.filter(n => n.parentElement); // remove if removed
}

// Handle key presses for hitting notes
document.addEventListener('keydown', e => {
  if (!running) return;
  const keys = ['d','f','j','k'];
  const laneIndex = keys.indexOf(e.key.toLowerCase());
  if (laneIndex === -1) return;
  hit(laneIndex);
});

// Judge if a note is hit correctly
function hit(laneIndex) {
  for (let i=0;i<notes.length;i++) {
    const note = notes[i];
    if (parseInt(note.dataset.lane) === laneIndex) {
      const top = parseInt(note.style.top);
      if (top >= 420 && top <= 460) { // near hit line
        note.remove();
        notes.splice(i,1);
        combo++;
        comboEl.textContent = 'Combo: ' + combo;
        showEffect(laneIndex);
        return;
      }
    }
  }
  endGame();
}

// Flash effect when a note is hit
function showEffect(laneIndex) {
  const effect = document.createElement('div');
  effect.className = 'effect';
  lanes[laneIndex].appendChild(effect);
  setTimeout(() => effect.remove(), 300);
}

// Display result modal and high scores
function showResult() {
  resultText.textContent = '記録: ' + combo;
  const records = getRecords();
  recordsEl.innerHTML = "<h3>トップ5</h3>" + records.map((r,i) => `${i+1}. ${r}`).join("<br>");
  result.style.display = "flex";
}

// Load records from localStorage
function getRecords() {
  const data = localStorage.getItem('records');
  return data ? JSON.parse(data) : [];
}

// Store new record and keep top 5
function updateRecords(score) {
  const records = getRecords();
  records.push(score);
  records.sort((a,b) => b-a);
  while(records.length > 5) records.pop();
  localStorage.setItem('records', JSON.stringify(records));
}

// UI events
retryBtn.addEventListener('click', startGame);
retryToggle.addEventListener('change', e => {
  retryBtn.disabled = !e.target.checked;
});

// Launch the first game automatically
startGame();
</script>
</body>
</html>
